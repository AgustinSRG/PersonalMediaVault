import { Button, VerticalBox, HorizontalBox, Palette, ScrollView } from "std-widgets.slint";
import { AboutComponent } from "about.slint";
import { LauncherStatus, FatalErrorType, OpenErrorType, VaultDaemonStatus, VaultDaemonErrorType } from "status.slint";
import { VaultClosedView } from "vault-closed.slint";
import { OpeningView } from "opening.slint";
import { FatalErrorView } from "fatal-error.slint";
import { OpenErrorView } from "open-error.slint";
import { CreateFolderAskView } from "create-folder-ask.slint";
import { LockAskView } from "lock-ask.slint";
import { InitialConfigView } from "initial-config.slint";
import { CreateVaultView } from "create-vault.slint";
import { VaultOpenView } from "vault-open.slint";

export { LauncherStatus, FatalErrorType, OpenErrorType, VaultDaemonStatus, VaultDaemonErrorType }

export component MainWindow inherits Window {
    icon: @image-url("../assets/favicon.png");
    title: @tr("PersonalMediaVault Launcher");

    /// The general status of the launcher
    in-out property <LauncherStatus> launcher-status: closed;

    /// Path of the vault
    in property <string> vault-path: "";

    preferred-width: 640px;
    preferred-height: 480px;

    /// PersonalMediaVault version
    in property <string> version: "1.0.0";

    /// Visit the PersonalMediaVault Website
    callback visit-website();

    /// Visit GitHub page
    callback visit-git();

    /// Close callback
    callback close-launcher();

    /// True if the launcher is busy, meaning the action buttons should be disabled
    in property <bool> busy: false;

    /// Type of fatal error that occurred
    in property <FatalErrorType> fatal-error-type: unknown;

    /// Type of open error that occurred
    in property <OpenErrorType> open-error-type: unknown;

    /// Details of the error opening the vault
    in-out property <string> open-error-details: "";

    /// Select a folder and open the vault store there
    callback open-vault-folder();

    /// Open the default vault, located in the user's home folder
    callback open-default-vault();

    /// Create the folder and open it
    callback create-folder-and-open();

    /// Forcefully open the vault (locked)
    callback force-open();

    /// Hostname to open browser
    in-out property <string> hostname: "localhost";
    in-out property <bool> hostname-invalid: false;

    /// Listening port
    in-out property <string> port: "8000";
    in-out property <bool> port-invalid: false;

    /// Local listening
    in-out property <bool> listen-local: true;

    /// Initial config
    callback set-initial-config();

    /// Username input
    in-out property <string> username: "";
    in-out property <bool> username-invalid: false;

    /// Password input
    in-out property <string> password: "";
    in-out property <bool> password-invalid: false;

    /// Password input (repeat)
    in-out property <string> password-repeat: "";
    in-out property <bool> password-repeat-invalid: false;

    /// Create vault
    callback create-vault();

    /// Close vault
    callback close-vault();

    /// Status of the vault daemon
    in property <VaultDaemonStatus> daemon-status: VaultDaemonStatus.stopped;

    /// Daemon error type
    in property <VaultDaemonErrorType> daemon-error-type: VaultDaemonErrorType.unknown;

    /// Daemon error details
    in property <string> daemon-error-details: "";

    /// Start callback
    callback start();

    /// Stop callback
    callback stop();

    /// Restart callback
    callback restart();

    /// Open browser callback
    callback open-browser();

    /// Open log callback
    callback open-log();

    VerticalBox {
        AboutComponent {
            version: version;
            visit-website => {
                root.visit-website();
            }
            visit-git => {
                root.visit-git();
            }
        }

        Rectangle {
            border-width: 0;
            height: 1px;
            background: Palette.border;
        }

        VerticalLayout {
            if(launcher-status == LauncherStatus.closed): VaultClosedView {
                busy: busy;
                open-default-vault => {
                    root.open-default-vault();
                }
                open-vault-folder => {
                    root.open-vault-folder();
                }
            }

            if(launcher-status == LauncherStatus.fatal-error): FatalErrorView {
                fatal-error-type: fatal-error-type;
                close-launcher => {
                    root.close-launcher();
                }
            }

            if(launcher-status == LauncherStatus.opening): OpeningView {
                vault-path: vault-path;
            }

            if(launcher-status == LauncherStatus.open-error): OpenErrorView {
                open-error-type: open-error-type;
                open-error-details: open-error-details;
                vault-path: vault-path;
                go-back => {
                    root.open-error-details = "";
                    root.launcher-status = LauncherStatus.closed;
                }
            }

            if(launcher-status == LauncherStatus.create-ask): CreateFolderAskView {
                vault-path: vault-path;
                confirm => {
                    root.launcher-status = LauncherStatus.opening;
                    root.create-folder-and-open();
                }
                go-back => {
                    root.launcher-status = LauncherStatus.closed;
                }
            }

            if(launcher-status == LauncherStatus.lock-ask): LockAskView {
                vault-path: vault-path;
                confirm => {
                    root.launcher-status = LauncherStatus.opening;
                    root.force-open();
                }
                go-back => {
                    root.launcher-status = LauncherStatus.closed;
                }
            }

            if(launcher-status == LauncherStatus.initial-config): InitialConfigView {
                busy: busy;
                vault-path: vault-path;
                hostname <=> root.hostname;
                hostname-invalid <=> root.hostname-invalid;
                port <=> root.port;
                port-invalid <=> root.port-invalid;
                listen-local <=> root.listen-local;
                confirm => {
                    root.set-initial-config();
                }
                go-back => {
                    root.close-vault();
                }
            }

            if(launcher-status == LauncherStatus.create-vault-ask): CreateVaultView {
                busy: busy;
                vault-path: vault-path;
                username <=> username;
                username-invalid <=> username-invalid;
                password <=> password;
                password-invalid <=> password-invalid;
                password-repeat <=> password-repeat;
                password-repeat-invalid <=> password-repeat-invalid;
                confirm => {
                    root.create-vault();
                }
                go-back => {
                    root.close-vault();
                }
            }

            if(launcher-status == LauncherStatus.open): VaultOpenView {
                busy: busy;
                vault-path: vault-path;
                daemon-status: daemon-status;
                daemon-error-type: daemon-error-type;
                daemon-error-details: daemon-error-details;
                start => {
                    root.start();
                }
                stop => {
                    root.stop();
                }
                restart => {
                    root.restart();
                }
                open-browser => {
                    root.open-browser();
                }
                open-log => {
                    root.open-log();
                }
            }
        }
    }
}
